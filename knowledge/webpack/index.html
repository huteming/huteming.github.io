<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>webpack 基本原理 | 特明的日志</title>
    <meta name="description" content="webpack 基本原理介绍">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.7f63faaf.css" as="style"><link rel="preload" href="/assets/js/app.f913f9d4.js" as="script"><link rel="preload" href="/assets/js/6.7ebaf463.js" as="script"><link rel="preload" href="/assets/js/4.af9338ed.js" as="script"><link rel="preload" href="/assets/js/38.38469638.js" as="script"><link rel="prefetch" href="/assets/js/1.2ea39911.js"><link rel="prefetch" href="/assets/js/10.7814a16a.js"><link rel="prefetch" href="/assets/js/11.1a4b8928.js"><link rel="prefetch" href="/assets/js/12.100a1a10.js"><link rel="prefetch" href="/assets/js/13.1ecf7c4a.js"><link rel="prefetch" href="/assets/js/14.cd66458a.js"><link rel="prefetch" href="/assets/js/15.79f54e90.js"><link rel="prefetch" href="/assets/js/16.4ed9d7e2.js"><link rel="prefetch" href="/assets/js/17.99f28218.js"><link rel="prefetch" href="/assets/js/18.eced304a.js"><link rel="prefetch" href="/assets/js/19.6c5626d7.js"><link rel="prefetch" href="/assets/js/20.dc5afa1f.js"><link rel="prefetch" href="/assets/js/21.803e0f31.js"><link rel="prefetch" href="/assets/js/22.e1579b99.js"><link rel="prefetch" href="/assets/js/23.7b413778.js"><link rel="prefetch" href="/assets/js/24.8cfd9c52.js"><link rel="prefetch" href="/assets/js/25.20c14f78.js"><link rel="prefetch" href="/assets/js/26.141777bd.js"><link rel="prefetch" href="/assets/js/27.b706cecf.js"><link rel="prefetch" href="/assets/js/28.3d1f27c4.js"><link rel="prefetch" href="/assets/js/29.7a30e9af.js"><link rel="prefetch" href="/assets/js/30.73b85e87.js"><link rel="prefetch" href="/assets/js/31.623dcf40.js"><link rel="prefetch" href="/assets/js/32.d564fb82.js"><link rel="prefetch" href="/assets/js/33.d7be1f48.js"><link rel="prefetch" href="/assets/js/34.5e0b04a1.js"><link rel="prefetch" href="/assets/js/35.716047e7.js"><link rel="prefetch" href="/assets/js/36.e0001180.js"><link rel="prefetch" href="/assets/js/37.4680380a.js"><link rel="prefetch" href="/assets/js/39.b3e32c88.js"><link rel="prefetch" href="/assets/js/40.ed4928ef.js"><link rel="prefetch" href="/assets/js/41.518609f3.js"><link rel="prefetch" href="/assets/js/42.8f3e635e.js"><link rel="prefetch" href="/assets/js/43.ed5ca0b7.js"><link rel="prefetch" href="/assets/js/5.edb5ba7a.js"><link rel="prefetch" href="/assets/js/7.5fd9a5cc.js"><link rel="prefetch" href="/assets/js/8.404a9741.js"><link rel="prefetch" href="/assets/js/9.c1b70d79.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.73fe3575.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7f63faaf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">特明的日志 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">编程</a></li><li class="nav-item"><a href="/react/" class="nav-link">react</a></li><li class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></li><li class="nav-item"><a href="/knowledge/" class="nav-link router-link-active">知识点</a></li><li class="nav-item"><a href="/tools/" class="nav-link">工具指南</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">特明的日志 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">编程</a></li><li class="mobile-nav-item"><a href="/react/" class="nav-link">react</a></li><li class="mobile-nav-item"><a href="/algorithm/" class="nav-link">算法</a></li><li class="mobile-nav-item"><a href="/knowledge/" class="nav-link router-link-active">知识点</a></li><li class="mobile-nav-item"><a href="/tools/" class="nav-link">工具指南</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        webpack 基本原理
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-03-22T00:00:00.000Z">
      2021-03-22
    </time></div> <!----></div></header> <div itemprop="articleBody" class="content__default"><hr> <h2 id="模块化系统"><a href="#模块化系统" class="header-anchor">#</a> 模块化系统</h2> <p>前端产品的交付是基于浏览器，这些资源是通过增量加载的方式运行到浏览器端，如何在开发环境组织好这些碎片化的代码和资源，并且保证他们在浏览器端快速、优雅的加载和更新，就需要一个模块化系统。</p> <div class="custom-block tip"><p class="custom-block-title">如何更好的在浏览器环境组织资源?</p> <p>若是每个文件都单独请求，会导致请求次数过多，导致启动速度过慢。若是全部打包在一块只请求一次，会导致流量浪费，初始化过程慢。因此<strong>最佳方案是分块传输，按需进行懒加载，在实际用到某些模块的时候再增量更新。</strong></p></div> <p><strong>模块系统主要解决模块的定义、依赖和导出</strong>。 原始的<code>&lt;script&gt;</code>标签加载方式有一些常见的弊端：例如全局作用域下容易造成变量冲突；文件只能按照<code>&lt;script&gt;</code>的书写顺序进行加载；开发人员必须主观解决模块和代码库的依赖关系等。</p> <h2 id="模块化方案"><a href="#模块化方案" class="header-anchor">#</a> 模块化方案</h2> <h3 id="commonjs"><a href="#commonjs" class="header-anchor">#</a> CommonJs</h3> <ul><li><p>优点：服务器端模块便于重用。</p></li> <li><p>缺点：同步的模块加载方式不适合在浏览器环境中，同步意味着阻塞加载，浏览器资源是异步加载的。</p></li></ul> <h3 id="amd"><a href="#amd" class="header-anchor">#</a> AMD</h3> <p>依赖前置。</p> <ul><li><p>优点：适合在浏览器环境异步加载；</p></li> <li><p>缺点：阅读和书写比较困难。</p></li></ul> <h3 id="cmd"><a href="#cmd" class="header-anchor">#</a> CMD</h3> <p>依赖就近，延迟执行。</p> <ul><li><p>优点：很容易在 node 中运行；</p></li> <li><p>缺点：依赖 spm 打包，模块的加载逻辑偏重。</p></li></ul> <h3 id="es6-模块"><a href="#es6-模块" class="header-anchor">#</a> ES6 模块</h3> <p>尽量的静态化，使得编译时就能确定模块的依赖关系，以及输入输出的变量。CommonJS 和 AMD 模块，都只能在运行时确定这些东西。</p> <ul><li><p>优点：容易进行静态分析；</p></li> <li><p>缺点：原生浏览器未实现该标准。</p></li></ul> <h2 id="模块打包器"><a href="#模块打包器" class="header-anchor">#</a> 模块打包器</h2> <p>Webpack 是一个模块打包器。它将根据模块的依赖关系进行静态分析，然后将这些模块按照指定的规则生成对应的静态资源。</p> <h2 id="webpack-构建流程概括"><a href="#webpack-构建流程概括" class="header-anchor">#</a> Webpack 构建流程概括</h2> <p>Webpack 的运行流程是一个串行的过程，从启动到结束会依次执行以下流程：</p> <h3 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h3> <p>启动构建，读取与合并配置参数，加载 Plugin，实例化 Compiler。</p> <ol><li><p>初始化参数：从配置文件和 Shell 语句中读取与合并参数，得出最终的参数；</p></li> <li><p>开始编译：用上一步得到的参数初始化 Compiler 对象，加载所有配置的插件，执行对象的 run 方法开始执行编译；</p></li></ol> <h3 id="编译构建"><a href="#编译构建" class="header-anchor">#</a> 编译构建</h3> <p>从 Entry 发出，针对每个 Module 串行调用对应的 Loader 去翻译文件内容，再找到该 Module 依赖的 Module，递归地进行编译处理。</p> <ol><li><p>确定入口：根据配置中的 entry 找出所有的入口文件；</p></li> <li><p>编译模块：从入口文件出发，调用所有配置的 Loader 对模块进行翻译，再找出该模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理；</p></li> <li><p>完成模块编译：在经过第 4 步使用 Loader 翻译完所有模块后，得到了每个模块被翻译后的最终内容以及它们之间的依赖关系；</p></li></ol> <h3 id="输出"><a href="#输出" class="header-anchor">#</a> 输出</h3> <p>对编译后的 Module 组合成 Chunk，把 Chunk 转换成文件，输出到文件系统。</p> <ol><li><p>输出资源：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 Chunk，再把每个 Chunk 转换成一个单独的文件加入到输出列表，这步是可以修改输出内容的最后机会；</p></li> <li><p>输出完成：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统。</p></li></ol> <h2 id="webpack-4-46-0-结果"><a href="#webpack-4-46-0-结果" class="header-anchor">#</a> Webpack 4.46.0 结果</h2> <p>无论开发使用的是 <code>CommonJS</code> 规范还是 <code>ES6</code> 模块规范，打包后的文件都是统一使用 <code>Webpack</code> 自定义的规范来管理、加载模块。</p> <h3 id="commonjs-规范"><a href="#commonjs-规范" class="header-anchor">#</a> CommonJS 规范</h3> <p>打包后的代码其实就是一个立即执行函数，传入的参数是一个对象，这个对象以文件路径为 key，以文件内容为 value，它包含了所有打包后的模块</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;./src/hello.js&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">eval</span><span class="token punctuation">(</span>
      <span class="token string">'module.exports = () =&gt; {\n  console.log(&quot;hello world&quot;);\n};\n\n\n//# sourceURL=webpack:///./src/hello.js?'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;./src/index.js&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">eval</span><span class="token punctuation">(</span>
      <span class="token string">'const hello = __webpack_require__(/*! ./hello */ &quot;./src/hello.js&quot;);\n\n// import(&quot;./async&quot;).then((str) =&gt; {\n//   console.log(&quot;加载异步文件&quot;, str);\n//   hello();\n// });\n\nhello();\n\n\n//# sourceURL=webpack:///./src/index.js?'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个立即函数简化下，相当于</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// ...这里有一些其他代码</span>

  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个立即函数做了什么</p> <ol><li><p>定义了一个模块缓存对象 <code>installedModules</code>，作用是缓存已经加载过的模块</p></li> <li><p>定义一个模块加载函数 <code>__webpack_require__</code></p></li> <li><p>使用 <code>__webpack_require__</code> 加载入口模块</p></li></ol> <p>这里最核心的就是 <code>__webpack_require__</code> 函数，它接收的参数是 moduleId，其实就是文件路径。它的执行过程是这样的：</p> <ol><li><p>判断模块是否有缓存，如果有，则返回该模块的 exports 对象，即 module.exports</p></li> <li><p>新建一个模块 module，并放入缓存</p></li> <li><p>执行文件路径对应的模块函数</p></li> <li><p>将这个新建的模块标识为已加载</p></li> <li><p>执行完模块后，返回该模块的 exports 对象</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    i<span class="token operator">:</span> moduleId<span class="token punctuation">,</span>
    l<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
    module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>
    module<span class="token punctuation">,</span>
    module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>
    __webpack_require__
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，在执行模块函数时传入了三个参数，分别是 <code>module</code>、<code>module.exports</code>、<code>__webpack_require__</code>，这三个的作用分别对应 CommonJS 中的 <code>module</code>、<code>module.exports</code>、<code>require</code></p> <p>接下来看下入口模块的内容，下面是 eval 函数内容美化后的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hello <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">&quot;./src/hello.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，打包后的模块代码和原模块代码仅仅只有一个地方发生了变化，那就是 <code>require</code> 变成了 <code>__webpack_require__</code>。</p> <p>稍微总结一下，<code>__webpack_require__</code> 加载模块后，会先执行对应的函数，然后返回该模块的 <code>module.exports</code> 对象，然后在依赖这个模块的地方，能通过 <code>__webpack_require__</code> 函数导入，进而继续使用。可以发现，webpack 自定义的模块规范完美适配 CommonJS 规范。</p> <h3 id="es6-module"><a href="#es6-module" class="header-anchor">#</a> ES6 module</h3> <p>使用 ES6 module 规范打包后的代码和使用 CommonJS 规范打包后的代码绝大部分是一样的。</p> <p><strong>一样的地方是指 Webpack 自定义模块规范的代码，不同的是两个文件打包后的代码。</strong></p> <p>先把两个文件打包后的 eval 中的代码美化下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _hello__WEBPACK_IMPORTED_MODULE_0__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>
    <span class="token string">&quot;./src/hello.js&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Object</span><span class="token punctuation">(</span>_hello__WEBPACK_IMPORTED_MODULE_0__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 给 __webpack_exports__ 对象添加 default 属性</span>
  <span class="token comment">// 有些地方是用 __webpack_require__.d 方法赋值，作用是一样的</span>
  __webpack_exports__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里有几点需要注意的，</p> <ul><li><p>模块函数的第二个参数变成了 <code>__webpack_exports__</code>，这个在 CommonJs 规范对应的是 exports</p></li> <li><p>模块函数的开头都执行了一个 <code>__webpack_require__.r</code> 函数</p></li></ul> <p>先说说 <code>__webpack_require__.r</code></p> <div class="language-js extra-class"><pre class="language-js"><code>__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">r</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Symbol <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">&amp;&amp;</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">&quot;Module&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>它的作用就是给 <code>__webpack_exports__</code> 添加一个 <code>__esModule</code> 为 true 的属性，表示这个一个 ES module</p> <h4 id="esmodule-的作用"><a href="#esmodule-的作用" class="header-anchor">#</a> __esModule 的作用</h4> <p>这个主要是为了处理混合使用 ES6 module 和 CommonJS 的情况。</p> <p>例如导出使用 CommonJS 的 <code>module.exports</code>，而导入使用 ES6 module 的 <code>import</code></p> <p>先看打包后的代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _hello__WEBPACK_IMPORTED_MODULE_0__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span>
    <span class="token string">&quot;./src/hello.js&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _hello__WEBPACK_IMPORTED_MODULE_0___default <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">n</span><span class="token punctuation">(</span>
    _hello__WEBPACK_IMPORTED_MODULE_0__
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_hello__WEBPACK_IMPORTED_MODULE_0___default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">n</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> getter <span class="token operator">=</span>
    module <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>__esModule
      <span class="token operator">?</span> <span class="token keyword">function</span> <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> module<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">getModuleExports</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> module<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
  __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> getter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> getter<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>分析下处理逻辑</p> <ol><li><p>将 <code>__webpack_exports__</code> 导出对象标识为 ES6 module。</p></li> <li><p>加载依赖模块，并将模块的导出对象作为参数传入 <code>__webpack_require__.n</code> 函数</p></li> <li><p><code>__webpack_require__.n</code> 分析该 <code>export</code> 对象是否为 <code>ES6 module</code>，如果是，则返回 <code>module['default']</code>，如果不是，则直接返回 <code>export</code></p></li></ol> <div class="custom-block tip"><p class="custom-block-title">提醒</p> <p>这里分析的是使用 <code>module.exports</code> 导出，使用 <code>import</code> 导入，webpack 会自动处理。但如果是反过来，使用 <code>export</code> 导出，使用 <code>require</code> 导入，则必须手动读取 <code>default</code> 属性，</p></div> <h3 id="按需加载"><a href="#按需加载" class="header-anchor">#</a> 按需加载</h3> <p>在 webpack 中可以使用 <code>import</code> 和 <code>require.ensure</code> 来引入需要动态导入的模块，示例代码如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./hello.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">hello</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  hello<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hello<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// hello.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>动态加载的模块，在打包时会被单独打包成一个文件，而不是和 index.js 一起打包到 bundle.js。</p> <p>先上这个时候打包生成的文件内容（摘要）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 立即执行函数</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>
    main<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">jsonpScriptSrc</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">&quot;.main.js&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> jsonpArray <span class="token operator">=</span> <span class="token punctuation">(</span>window<span class="token punctuation">[</span><span class="token string">&quot;webpackJsonp&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">&quot;webpackJsonp&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> oldJsonpFunction <span class="token operator">=</span> jsonpArray<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>jsonpArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
  jsonpArray<span class="token punctuation">.</span>push <span class="token operator">=</span> webpackJsonpCallback<span class="token punctuation">;</span>
  jsonpArray <span class="token operator">=</span> jsonpArray<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> jsonpArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span>jsonpArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> parentJsonpFunction <span class="token operator">=</span> oldJsonpFunction<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>大概分析下打包时和同步加载的 webpack 模块规范有哪些不同</p> <ol><li><p>定义了一个对象 <code>installedChunks</code>，作用是缓存动态模块</p></li> <li><p>定义一个辅助函数 <code>jsonpScriptSrc</code>，作用是根据模块 ID 生成 URL</p></li> <li><p>定义了两个核心函数 <code>__webpack_require__.e</code> 和 <code>webpackJsonpCallback</code></p></li> <li><p>定义了一个全局变量 <code>window[&quot;webpackJsonp&quot;]</code>，作用是存储需要动态导入的模块</p></li> <li><p>重写 <code>window[&quot;webpackJsonp&quot;]</code> 的 <code>push</code> 方法为 <code>webpackJsonpCallback</code></p></li></ol> <p>然后看下入口模块的代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  __webpack_require__
    <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;./src/hello.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">hello</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      hello<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      hello<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>原来模块代码中的 <code>import()</code> 被编译成了 <code>__webpack_require__.e(0).then()</code></p> <h4 id="webpack-require-e"><a href="#webpack-require-e" class="header-anchor">#</a> <strong>webpack_require</strong>.e</h4> <div class="language-js extra-class"><pre class="language-js"><code>__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> promises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// JSONP chunk loading for javascript</span>

  <span class="token keyword">var</span> installedChunkData <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunkData <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 0 means &quot;already installed&quot;.</span>

    <span class="token comment">// a Promise means &quot;currently loading&quot;.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunkData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// setup Promise in chunk cache</span>
      <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        installedChunkData <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> promise<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// start chunk loading</span>
      <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> onScriptComplete<span class="token punctuation">;</span>

      script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">;</span>
      script<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token number">120</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>nc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        script<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;nonce&quot;</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token function">jsonpScriptSrc</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// create error before stack unwound to get useful stacktrace later</span>
      <span class="token keyword">var</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function-variable function">onScriptComplete</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// avoid mem leaks in IE.</span>
        script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> script<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> chunk <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> errorType <span class="token operator">=</span>
              event <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;load&quot;</span> <span class="token operator">?</span> <span class="token string">&quot;missing&quot;</span> <span class="token operator">:</span> event<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> realSrc <span class="token operator">=</span> event <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>target <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src<span class="token punctuation">;</span>
            error<span class="token punctuation">.</span>message <span class="token operator">=</span>
              <span class="token string">&quot;Loading chunk &quot;</span> <span class="token operator">+</span>
              chunkId <span class="token operator">+</span>
              <span class="token string">&quot; failed.\n(&quot;</span> <span class="token operator">+</span>
              errorType <span class="token operator">+</span>
              <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span>
              realSrc <span class="token operator">+</span>
              <span class="token string">&quot;)&quot;</span><span class="token punctuation">;</span>
            error<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;ChunkLoadError&quot;</span><span class="token punctuation">;</span>
            error<span class="token punctuation">.</span>type <span class="token operator">=</span> errorType<span class="token punctuation">;</span>
            error<span class="token punctuation">.</span>request <span class="token operator">=</span> realSrc<span class="token punctuation">;</span>
            chunk<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onScriptComplete</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;timeout&quot;</span><span class="token punctuation">,</span> target<span class="token operator">:</span> script <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">120000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> script<span class="token punctuation">.</span>onload <span class="token operator">=</span> onScriptComplete<span class="token punctuation">;</span>
      document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>白话文翻译下它的处理逻辑</p> <ol><li><p>先查看该模块 ID 对应的缓存是否为 0，0 代表已经加载成功了，第一次取值为 undefined</p></li> <li><p>如果不为 0，并且不是 undefined 代表已经是加载中的状态，然后将这个加载中的 Promise 推入 promises 数组</p></li> <li><p>如果不为 0，并且是 undefined，就新建一个 Promise，用于加载需要动态导入的模块。</p></li> <li><p>生成一个 script 标签，URL 使用 <code>jsonpScriptSrc</code> 生成，即需要动态导入的模块的 URL。</p></li> <li><p>为这个 script 标签设置一个 2 分钟的超时时间</p></li> <li><p>添加到页面，开始加载模块</p></li> <li><p>返回 promises 数组</p></li></ol> <p>最后再看下 <code>hello.js</code> 生成的文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// hello.js</span>
<span class="token punctuation">(</span>window<span class="token punctuation">[</span><span class="token string">&quot;webpackJsonp&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> window<span class="token punctuation">[</span><span class="token string">&quot;webpackJsonp&quot;</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token string">&quot;./src/hello.js&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
      <span class="token parameter">module<span class="token punctuation">,</span>
      __webpack_exports__<span class="token punctuation">,</span>
      __webpack_require__</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      __webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __webpack_require__<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> test<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      __webpack_exports__<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到，加载动态模块，自动执行入口文件中 <code>window[&quot;webpackJsonp&quot;]</code> 的 <code>push</code> 方法，也就是执行 <code>webpackJsonpCallback</code> 方法，放入动态模块，这样就把动态模块和主流程关联起来了。</p> <p>这里参数有两个，第一个是 [0]，它是模块的 ID，第二个是模块路径名和模块内容</p> <h4 id="webpackjsonpcallback"><a href="#webpackjsonpcallback" class="header-anchor">#</a> webpackJsonpCallback</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> chunkIds <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> moreModules <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// add &quot;moreModules&quot; to the modules object,</span>
  <span class="token comment">// then flag all &quot;chunkIds&quot; as loaded and fire callback</span>
  <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>
    chunkId<span class="token punctuation">,</span>
    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>installedChunks<span class="token punctuation">,</span> chunkId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>moreModules<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parentJsonpFunction<span class="token punctuation">)</span> <span class="token function">parentJsonpFunction</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>resolves<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    resolves<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同样也是白话文翻译下流程</p> <ol><li><p>执行对应模块的 resolve 方法，同时将缓存对象中的值置为 0，标识已经加载完成了</p></li> <li><p>执行模块方法，将模块内容添加到 <code>modules</code> 中，</p></li> <li><p>将模块添加到 <code>window[&quot;webpackJsonp&quot;]</code> 中。</p></li></ol> <h4 id="动态导入逻辑总结"><a href="#动态导入逻辑总结" class="header-anchor">#</a> 动态导入逻辑总结</h4> <ol><li><p>重写 <code>window[&quot;webpackJsonp&quot;]</code> 方法</p></li> <li><p>入口模块使用 <code>__webpack_require__.e</code> 下载动态资源</p></li> <li><p>资源下载完成后执行 <code>window[&quot;webpackJsonp&quot;].push</code>，即 <code>webpackJsonpCallback</code></p></li> <li><p>下载完成后调用 <code>__webpack_require__</code> 真正开始加载代码</p></li></ol></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#模块化系统" title="模块化系统">模块化系统</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#模块化方案" title="模块化方案">模块化方案</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#commonjs" title="CommonJs">CommonJs</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#amd" title="AMD">AMD</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#cmd" title="CMD">CMD</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#es6-模块" title="ES6 模块">ES6 模块</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#模块打包器" title="模块打包器">模块打包器</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#webpack-构建流程概括" title="Webpack 构建流程概括">Webpack 构建流程概括</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#初始化" title="初始化">初始化</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#编译构建" title="编译构建">编译构建</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#输出" title="输出">输出</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#webpack-4-46-0-结果" title="Webpack 4.46.0 结果">Webpack 4.46.0 结果</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#commonjs-规范" title="CommonJS 规范">CommonJS 规范</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#es6-module" title="ES6 module">ES6 module</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#按需加载" title="按需加载">按需加载</a></div></div></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f913f9d4.js" defer></script><script src="/assets/js/6.7ebaf463.js" defer></script><script src="/assets/js/4.af9338ed.js" defer></script><script src="/assets/js/38.38469638.js" defer></script>
  </body>
</html>
